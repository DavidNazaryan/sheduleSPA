# Устранение ошибок системы аутентификации

## Основные проблемы и решения

### 1. Ошибка 401 "Требуется аутентификация"

**Проблема**: При попытке добавить домашнее задание возникает ошибка 401.

**Причины**:
- Пользователь не аутентифицирован
- Данные аутентификации не передаются правильно
- Проблемы с токеном бота

**Решения**:

1. **Для тестирования**:
   - Используйте кнопку "Тестовый режим" в модальном окне аутентификации
   - Убедитесь, что в тестовом режиме пользователь имеет роль "monitor"

2. **Для Telegram WebApp**:
   - Убедитесь, что приложение запущено через Telegram
   - Проверьте, что токен бота настроен правильно в `app/auth.py`
   - Убедитесь, что WebApp настроен в @BotFather

3. **Проверка токена бота**:
   ```python
   # В файле app/auth.py замените:
   TELEGRAM_BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"
   # На реальный токен от @BotFather
   ```

### 2. Ошибка 403 "Недостаточно прав"

**Проблема**: Пользователь аутентифицирован, но не может добавлять домашние задания.

**Причины**:
- Пользователь имеет роль "student" вместо "monitor"
- Пользователь не принадлежит к группе

**Решения**:
- В тестовом режиме пользователь автоматически получает роль "monitor"
- В реальном приложении староста должен быть назначен через API

### 3. Ошибка подключения к серверу

**Проблема**: JavaScript не может подключиться к API.

**Причины**:
- Сервер не запущен
- Неправильный URL
- Проблемы с CORS

**Решения**:
1. Запустите сервер:
   ```bash
   uvicorn app.main:app --reload
   ```

2. Проверьте, что сервер доступен по адресу `http://localhost:8000`

3. Откройте консоль браузера (F12) для просмотра ошибок

### 4. Кнопки "Добавить ДЗ" не отображаются

**Проблема**: Кнопки для добавления домашнего задания не видны.

**Причины**:
- Пользователь не аутентифицирован
- Пользователь не имеет прав на редактирование
- JavaScript не загрузился

**Решения**:
1. Убедитесь, что пользователь аутентифицирован
2. Проверьте, что `authManager.permissions.canEdit` равно `true`
3. Откройте консоль браузера для проверки ошибок JavaScript

### 5. Домашние задания не сохраняются

**Проблема**: Домашние задания добавляются, но не сохраняются между сессиями.

**Причина**: В текущей реализации домашние задания не сохраняются в базе данных.

**Решение**: Добавьте сохранение в базу данных (см. TODO в коде).

## Отладка

### 1. Проверка в консоли браузера

Откройте консоль браузера (F12) и проверьте:
- Ошибки JavaScript
- Сетевые запросы к API
- Состояние `authManager`

### 2. Проверка логов сервера

В терминале, где запущен сервер, проверьте:
- Ошибки Python
- HTTP запросы
- Ошибки аутентификации

### 3. Тестовый скрипт

Запустите тестовый скрипт:
```bash
python test_auth.py
```

## Частые ошибки

### "ModuleNotFoundError: No module named 'app'"

**Решение**: Запускайте сервер из корневой директории проекта:
```bash
cd /path/to/schedule-spa
uvicorn app.main:app --reload
```

### "ImportError: cannot import name 'TelegramUser'"

**Решение**: Убедитесь, что все файлы находятся в правильных местах:
- `app/auth.py`
- `app/user_management.py`
- `app/main.py`

### "TypeError: 'NoneType' object is not callable"

**Решение**: Убедитесь, что все функции асинхронные и правильно вызываются.

## Контакты

Если проблемы не решаются, проверьте:
1. Логи сервера
2. Консоль браузера
3. Сетевые запросы в DevTools
4. Правильность настройки токена бота

