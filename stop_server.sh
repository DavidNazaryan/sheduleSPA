#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
# –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ stop_server.sh –∏ —Å–¥–µ–ª–∞–π—Ç–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º: chmod +x stop_server.sh

echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ú–ì–£"
echo "===================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä
if ! pgrep -f "uvicorn" > /dev/null; then
    echo "‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞
SERVER_PID=$(pgrep -f uvicorn)
echo "–ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å —Å PID: $SERVER_PID"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä..."
kill $SERVER_PID

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
sleep 2

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
if pgrep -f "uvicorn" > /dev/null; then
    echo "‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."
    kill -9 $SERVER_PID
    sleep 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
if ! pgrep -f "uvicorn" > /dev/null; then
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    
    # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª PID
    if [ -f "logs/server.pid" ]; then
        rm logs/server.pid
    fi
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä!"
    exit 1
fi

echo ""
echo "üìã –î–ª—è –∑–∞–ø—É—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ./start_server.sh"

